# TianShanOS å†…å­˜ä½¿ç”¨ç°çŠ¶æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2024-01-24  
**ç‰ˆæœ¬**: v0.3.0+674e19e  
**ç›®æ ‡èŠ¯ç‰‡**: ESP32-S3

## æ‰§è¡Œæ‘˜è¦

ç»è¿‡æ„å»ºé”™è¯¯ä¿®å¤å’Œé‡æ–°ç¼–è¯‘ï¼ŒDRAM ä½¿ç”¨ç‡å·²ä» **86% é™è‡³ 52.35%**ï¼Œå½“å‰å†…å­˜ä½¿ç”¨å¥åº·ï¼Œå·²è¾¾åˆ°å¯æ¥å—èŒƒå›´ï¼ˆå»ºè®® 55-65%ï¼‰ã€‚

## å½“å‰å†…å­˜åˆ†é…

### ç¼–è¯‘æ—¶å†…å­˜ä½¿ç”¨ï¼ˆBuild Size Analysisï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”“
â”‚ Memory Type         â”‚ Used [bytes] â”‚ Used [%] â”‚ Remain [bytes] â”‚ Total [bytes] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DIRAM (DRAM)        â”‚      178,899 â”‚   52.35  â”‚        162,861 â”‚       341,760 â”‚
â”‚   .text (code)      â”‚      103,247 â”‚   30.21  â”‚                â”‚               â”‚
â”‚   .bss (æœªåˆå§‹åŒ–)   â”‚       51,680 â”‚   15.12  â”‚                â”‚               â”‚
â”‚   .data (å·²åˆå§‹åŒ–)  â”‚       23,972 â”‚    7.01  â”‚                â”‚               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IRAM (å¿«é€Ÿè®¿é—®)     â”‚       16,384 â”‚  100.0   â”‚              0 â”‚        16,384 â”‚
â”‚   .text (ä¸­æ–­ä»£ç )  â”‚       15,356 â”‚   93.73  â”‚                â”‚               â”‚
â”‚   .vectors          â”‚        1,028 â”‚    6.27  â”‚                â”‚               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Flash Code (.text)  â”‚    1,341,206 â”‚          â”‚                â”‚               â”‚
â”‚ Flash Data (.rodata)â”‚      535,968 â”‚          â”‚                â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»é•œåƒå¤§å°: 2,021,065 bytes (~1.93 MB)
```

### å…³é”®æŒ‡æ ‡

- **DRAM ä½¿ç”¨**: 178,899 / 341,760 bytes = **52.35%** âœ…
- **DRAM å‰©ä½™**: 162,861 bytes (~159 KB) âœ… å¥åº·æ°´å¹³
- **IRAM ä½¿ç”¨**: 16,384 / 16,384 bytes = **100%** âš ï¸ å·²æ»¡ï¼ˆæ­£å¸¸ï¼‰
- **PSRAM**: æœªåœ¨ç¼–è¯‘æŠ¥å‘Šä¸­æ˜¾ç¤ºï¼ˆè¿è¡Œæ—¶åŠ¨æ€åˆ†é…ï¼‰

## é—®é¢˜è¯Šæ–­ä¸è§£å†³

### é—®é¢˜1ï¼šåŸå§‹æŠ¥å‘Š DRAM 86% ä½¿ç”¨ç‡ âœ… å·²è§£å†³

**åŸå› **ï¼š
1. æ„å»ºé”™è¯¯å¯¼è‡´æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶æœªæ›´æ–°
2. å¤šä¸ªç»„ä»¶å¼•ç”¨ä¸å­˜åœ¨çš„ `ts_https` ç›¸å…³ä»£ç 
3. CMakeLists.txt ä¸­åŒ…å«å·²åˆ é™¤æ–‡ä»¶çš„å¼•ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç§»é™¤æ‰€æœ‰ HTTPS ç›¸å…³é—ç•™ä»£ç ï¼ˆcommit 674e19eï¼‰
- æ¸…ç† CMakeLists.txt æ„å»ºé…ç½®
- é‡æ–°ç¼–è¯‘ç”Ÿæˆæ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶

**ç»“æœ**ï¼šDRAM ä½¿ç”¨ç‡é™è‡³ 52.35%ï¼Œè¿›å…¥å¥åº·èŒƒå›´

### é—®é¢˜2ï¼šIRAM 100% ä½¿ç”¨ç‡ âš ï¸ éœ€ç›‘æ§

**ç°çŠ¶**ï¼š
- IRAM ä»… 16 KBï¼Œå­˜æ”¾ä¸­æ–­å¤„ç†å’Œæ—¶é—´æ•æ„Ÿä»£ç 
- 100% ä½¿ç”¨ç‡åœ¨ ESP32 é¡¹ç›®ä¸­æ˜¯æ­£å¸¸ç°è±¡

**å½±å“**ï¼š
- æ— æ³•æ·»åŠ æ›´å¤š IRAM ä»£ç ï¼ˆå¦‚é«˜é€Ÿä¸­æ–­å¤„ç†å™¨ï¼‰
- ä¸å½±å“æ™®é€šåŠŸèƒ½å¼€å‘ï¼ˆFlash æ‰§è¡Œå³å¯ï¼‰

**å»ºè®®**ï¼š
- é™¤ééœ€è¦æä½å»¶è¿Ÿä¸­æ–­ï¼Œæ— éœ€ä¼˜åŒ–
- å¦‚éœ€æ‰©å±• IRAMï¼Œéœ€ç§»é™¤ç°æœ‰ IRAM å‡½æ•°ï¼ˆé£é™©é«˜ï¼‰

## è¿è¡Œæ—¶å†…å­˜åˆ†æ

### å·¥å…·ä½¿ç”¨

æ–°å¢ CLI å‘½ä»¤ `system --memory-detail` ç”¨äºè¿è¡Œæ—¶åˆ†æï¼š

```bash
# åŸºç¡€å†…å­˜ä¿¡æ¯
system --info

# è¯¦ç»†å †å†…å­˜åˆ†æï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
system --memory-detail

# é¢„æœŸè¾“å‡ºï¼š
=== Detailed Heap Memory Analysis ===

[DRAM - Internal RAM]
  Capabilities: MALLOC_CAP_INTERNAL | MALLOC_CAP_8BIT
  Heap Summary:
    Total Size: 301312 bytes
    Free: 162861 bytes (54%)
    Allocated: 138451 bytes (46%)
    Largest Free Block: 98304 bytes
    Minimum Ever Free: 138000 bytes

[PSRAM - External RAM]
  Capabilities: MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
  Heap Summary:
    Total Size: 8388608 bytes (8 MB)
    Free: 5767168 bytes (69%)
    Allocated: 2621440 bytes (31%)
    Largest Free Block: 5242880 bytes (5 MB)

[DMA - DMA Capable RAM]
  Capabilities: MALLOC_CAP_DMA
  Total Size: ~35000 bytes
  Free: ~32000 bytes

ğŸ’¡ Optimization Tips:
  âœ… DRAM usage healthy (52%)
  âœ… PSRAM available (69% free)
  âš ï¸ IRAM full - cannot add more interrupt handlers
```

### å†…å­˜åˆ†é…å»ºè®®

æ ¹æ®å½“å‰çŠ¶æ€ï¼Œæ¨èä»¥ä¸‹åˆ†é…ç­–ç•¥ï¼š

1. **ç»§ç»­ä½¿ç”¨ DRAM çš„åœºæ™¯**ï¼š
   - å°äº 4 KB çš„ç¼“å†²åŒº
   - é¢‘ç¹è®¿é—®çš„æ•°æ®ç»“æ„
   - DMA éœ€è¦çš„ç¼“å†²åŒº

2. **åº”è¿ç§»åˆ° PSRAM çš„åœºæ™¯**ï¼š
   - WebSocket ç¼“å†²åŒºï¼ˆâ‰¥32 KBï¼‰
   - HTTP è¯·æ±‚/å“åº”ç¼“å†²åŒºï¼ˆâ‰¥16 KBï¼‰
   - å›¾åƒ/å¸§ç¼“å†²åŒºï¼ˆâ‰¥12 KBï¼‰
   - æ—¥å¿—ç¯å½¢ç¼“å†²åŒºï¼ˆå¦‚è¶…è¿‡ 8 KBï¼‰

3. **ç¦æ­¢ä½¿ç”¨ DRAM çš„åœºæ™¯**ï¼š
   - å¤§äº 32 KB çš„é™æ€æ•°ç»„
   - é•¿æœŸç¼“å­˜çš„æ•°æ®ï¼ˆé™¤é DMA å¿…éœ€ï¼‰

## ä¼˜åŒ–è·¯çº¿å›¾

### é˜¶æ®µ1ï¼šç›‘æ§ä¸åŸºçº¿å»ºç«‹ âœ… å®Œæˆ

- [x] å®ç° `system --memory-detail` å‘½ä»¤
- [x] ä¿®å¤æ„å»ºé”™è¯¯å¹¶é‡æ–°ç¼–è¯‘
- [x] ç¡®è®¤ DRAM ä½¿ç”¨ç‡å¥åº·ï¼ˆ52.35%ï¼‰
- [x] æ–‡æ¡£åŒ–å½“å‰å†…å­˜å¸ƒå±€

### é˜¶æ®µ2ï¼šé¢„é˜²æ€§ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**ï¼šè¿›ä¸€æ­¥é™è‡³ 45-50%ï¼Œä¸ºæœªæ¥åŠŸèƒ½é¢„ç•™ç©ºé—´

**ä¼˜å…ˆçº§ä½**ï¼š
- [ ] è¯†åˆ«å¤§äº 16 KB çš„ DRAM ç¼“å†²åŒº
- [ ] è¿ç§» WebSocket ç¼“å†²åŒºåˆ° PSRAMï¼ˆå¦‚å­˜åœ¨ï¼‰
- [ ] è¿ç§» HTTP ç¼“å†²åŒºåˆ° PSRAM
- [ ] ä¼˜åŒ–æ—¥å¿—ç³»ç»Ÿç¼“å†²åŒºå¤§å°

**é¢„æœŸæ”¶ç›Š**ï¼š
- DRAM å¯é™è‡³ 45% (~150 KB ä½¿ç”¨)
- é¢å¤–é‡Šæ”¾ 20-30 KB ç©ºé—´

### é˜¶æ®µ3ï¼šé•¿æœŸç›‘æ§

**å·¥å…·é›†**ï¼š
1. **æ„å»ºæ—¶æ£€æŸ¥**ï¼š
   ```bash
   # ç›‘æ§æ¯æ¬¡æ„å»ºçš„å†…å­˜å˜åŒ–
   idf.py size > memory_report.txt
   diff memory_report_old.txt memory_report.txt
   ```

2. **è¿è¡Œæ—¶ç›‘æ§**ï¼š
   ```c
   // åœ¨å…³é”®æ“ä½œå‰åè®°å½•å†…å­˜
   heap_caps_print_heap_info(MALLOC_CAP_INTERNAL);
   ```

3. **CI/CD é›†æˆ**ï¼ˆæ¨èï¼‰ï¼š
   - æ„å»ºå¤±è´¥æ¡ä»¶ï¼šDRAM > 70%
   - è­¦å‘Šæ¡ä»¶ï¼šDRAM > 60%
   - è‡ªåŠ¨ç”Ÿæˆå†…å­˜å˜åŒ–æŠ¥å‘Š

## å†…å­˜ä¼˜åŒ–æœ€ä½³å®è·µ

### ä»£ç ç¼–å†™è§„èŒƒ

```c
// âœ… æ¨èï¼šå¤§ç¼“å†²åŒºä½¿ç”¨ PSRAM
char *large_buffer = heap_caps_malloc(32768, MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
if (!large_buffer) {
    // Fallback åˆ° DRAMï¼ˆä»…åœ¨ PSRAM ä¸å¯ç”¨æ—¶ï¼‰
    large_buffer = malloc(32768);
    ESP_LOGW(TAG, "Using DRAM for large buffer (PSRAM unavailable)");
}

// âœ… æ¨èï¼šå°ç¼“å†²åŒºç›´æ¥ä½¿ç”¨ malloc (é»˜è®¤ DRAM)
char small_buf[256];  // æ ˆä¸Šåˆ†é…
char *heap_buf = malloc(1024);  // å †ä¸Šåˆ†é… (DRAM)

// âŒ ç¦æ­¢ï¼šå¤§å‹é™æ€æ•°ç»„
static char bad_buffer[65536];  // å ç”¨ 64 KB DRAMï¼

// âœ… æ¨èï¼šæ”¹ä¸ºåŠ¨æ€åˆ†é…
static char *good_buffer = NULL;
void init() {
    good_buffer = heap_caps_malloc(65536, MALLOC_CAP_SPIRAM);
}
```

### menuconfig é…ç½®å»ºè®®

```
Component config â†’ ESP PSRAM â†’
  [*] Support for external, SPI-connected RAM
  [*] Ignore PSRAM when not found
  Allocate memory to PSRAM (Prefer internal)  # é¿å…é»˜è®¤ä½¿ç”¨ PSRAM å½±å“æ€§èƒ½
```

## å‚è€ƒèµ„æ–™

- ESP-IDF å†…å­˜ç±»å‹è¯´æ˜ï¼šhttps://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/api-guides/memory-types.html
- heap_caps APIï¼š`components/heap/include/esp_heap_caps.h`
- TianShanOS å†…å­˜ä¼˜åŒ–æŒ‡å—ï¼š`docs/MEMORY_OPTIMIZATION.md`

## é™„å½•ï¼šå†…å­˜ç±»å‹å¯¹æ¯”è¡¨

| ç±»å‹   | å¤§å°       | é€Ÿåº¦ | ç”¨é€”                       | é™åˆ¶                   |
|--------|-----------|------|---------------------------|------------------------|
| IRAM   | 16 KB     | æœ€å¿« | ä¸­æ–­å¤„ç†ã€Cache å…³é—­æ—¶ä»£ç   | å®¹é‡å°ï¼Œ100% å·²ç”¨      |
| DRAM   | 341 KB    | å¿«   | é€šç”¨æ•°æ®ã€DMA ç¼“å†²åŒº        | å®¹é‡æœ‰é™ï¼ˆå½“å‰ 52%ï¼‰   |
| PSRAM  | 8 MB      | ä¸­ç­‰ | å¤§ç¼“å†²åŒºã€å›¾åƒæ•°æ®          | è®¿é—®å»¶è¿Ÿé«˜äº DRAM      |
| Flash  | 16 MB     | æ…¢   | ä»£ç ã€åªè¯»æ•°æ®ã€æ–‡ä»¶ç³»ç»Ÿ     | æ‰§è¡Œéœ€é€šè¿‡ Cache       |
| RTC    | 16 KB     | æ…¢   | Deep Sleep ä¿æŒæ•°æ®         | ä¸æ”¯æŒåŠ¨æ€åˆ†é…         |

---

**ç”Ÿæˆè€…**: GitHub Copilot (Claude Sonnet 4.5)  
**å·¥å…·é“¾**: ESP-IDF v5.5.2 + xtensa-esp-elf-gcc 14.2.0
